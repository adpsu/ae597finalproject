import pandas as pd
import geopandas as gpd
import numpy as np
import matplotlib.pyplot as plt

# Load the shapefile
shapefile_path = '/mnt/data/tl_2019_us_county.shp'
county_gdf = gpd.read_file(shapefile_path)

# Load the merged_county_df
merged_county_df_path = '/mnt/data/merged_county_df.csv'
merged_county_df = pd.read_csv(merged_county_df_path)

# Adjust the 'geography' column to have leading zeros where necessary to match GEOID
merged_county_df['geography'] = merged_county_df['geography'].apply(lambda x: str(x).zfill(5))

# Calculate the average of energy_per_hh
mean_energy = merged_county_df['energy_per_hh'].mean()

# Calculate the normalized deviated value of energy_per_hh
merged_county_df['energy_deviation'] = (merged_county_df['energy_per_hh'] - mean_energy) / mean_energy
merged_county_df['normalized_energy_deviation'] = (merged_county_df['energy_deviation'] - merged_county_df['energy_deviation'].min()) / (merged_county_df['energy_deviation'].max() - merged_county_df['energy_deviation'].min()) * 2 - 1

# Merge the shapefile with the dataframe on GEOID and geography
county_gdf = county_gdf.merge(merged_county_df, left_on='GEOID', right_on='geography', how='left')

# Plot the heat map
fig, ax = plt.subplots(1, 1, figsize=(15, 10))
county_gdf.plot(column='normalized_energy_deviation', cmap='coolwarm', linewidth=0.8, ax=ax, edgecolor='0.8', legend=True)
ax.set_title('Normalized Deviation of Energy per Household by County', fontsize=16)

plt.show()
